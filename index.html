<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lernen.IA - Plateforme d'√©tude</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50">
    <div id="app" class="p-4"></div>

    <script>
        const translations = {
            france: {
                chooseCountry: 'Choisissez votre pays',
                chooseClass: 'Choisissez votre classe',
                chooseSubject: 'Choisissez votre mati√®re',
                back: 'Retour',
                change: 'Changer',
                send: 'Envoyer',
                placeholder: 'Posez votre question ou demandez un exercice...',
                modeRevision: 'Mode R√©vision',
                modeRevisionDesc: 'Posez vos questions, demandez des explications et approfondissez vos connaissances',
                modeQuiz: 'Mode Exercices',
                modeQuizDesc: 'Pratiquez avec des exercices personnalis√©s et recevez des corrections',
                modeResolution: 'Mode R√©solution',
                modeResolutionDesc: 'Obtenez de l\'aide pour r√©soudre des exercices √©tape par √©tape',
                modePro: 'Mode Pro',
                modeProDesc: 'Analyses approfondies, recherche acad√©mique et projets avanc√©s pour √©tudes sup√©rieures',
                modeLanguages: 'Apprentissage des Langues',
                modeLanguagesDesc: 'Apprenez une nouvelle langue avec des exercices personnalis√©s',
                aboutTitle: '√Ä propos de Lernen.IA',
                developedBy: 'D√©velopp√© par Jules',
                studentAt: '√âtudiant en Bac Pro CIEL √† St Fran√ßois d\'Assise',
                tagline: 'R√©visez et pratiquez avec l\'intelligence artificielle'
            },
            usa: {
                chooseCountry: 'Choose your country',
                chooseClass: 'Choose your grade',
                chooseSubject: 'Choose your subject',
                back: 'Back',
                change: 'Change',
                send: 'Send',
                placeholder: 'Ask your question or request an exercise...',
                modeRevision: 'Review Mode',
                modeRevisionDesc: 'Ask questions, request explanations and deepen your knowledge',
                modeQuiz: 'Exercise Mode',
                modeQuizDesc: 'Practice with personalized exercises and receive corrections',
                modeResolution: 'Revision Mode',
                modeResolutionDesc: 'Get help to solve exercises step by step',
                modePro: 'Pro Mode',
                modeProDesc: 'In-depth analysis, academic research and advanced projects for higher education',
                modeLanguages: 'Language Learning',
                modeLanguagesDesc: 'Learn a new language with personalized exercises',
                aboutTitle: 'About Lernen.IA',
                developedBy: 'Developed by Jules',
                studentAt: 'Student in Bac Pro CIEL at St Fran√ßois d\'Assise',
                tagline: 'Study and practice with artificial intelligence'
            },
            uk: {
                chooseCountry: 'Choose your country',
                chooseClass: 'Choose your year',
                chooseSubject: 'Choose your subject',
                back: 'Back',
                change: 'Change',
                send: 'Send',
                placeholder: 'Ask your question or request an exercise...',
                modeRevision: 'Revision Mode',
                modeRevisionDesc: 'Ask questions, request explanations and deepen your knowledge',
                modeQuiz: 'Quiz Mode',
                modeQuizDesc: 'Test your knowledge with interactive quizzes and get instant scores',
                modeResolution: 'Problem Solving Mode',
                modeResolutionDesc: 'Solve exercises step by step with detailed corrections',
                modeLanguages: 'Language Learning',
                modeLanguagesDesc: 'Learn a new language with personalized exercises',
                aboutTitle: 'About Lernen.IA',
                developedBy: 'Developed by Jules',
                studentAt: 'Student in Bac Pro CIEL at St Fran√ßois d\'Assise',
                tagline: 'Study and practice with artificial intelligence'
            },
            germany: {
                chooseCountry: 'W√§hlen Sie Ihr Land',
                chooseClass: 'W√§hlen Sie Ihre Klasse',
                chooseSubject: 'W√§hlen Sie Ihr Fach',
                back: 'Zur√ºck',
                change: '√Ñndern',
                send: 'Senden',
                placeholder: 'Stellen Sie Ihre Frage oder fordern Sie eine √úbung an...',
                modeRevision: 'Wiederholungsmodus',
                modeRevisionDesc: 'Stellen Sie Fragen, fordern Sie Erkl√§rungen an und vertiefen Sie Ihr Wissen',
                modeQuiz: '√úbungsmodus',
                modeQuizDesc: '√úben Sie mit personalisierten √úbungen und erhalten Sie Korrekturen',
                modeResolution: 'L√∂sungsmodus',
                modeResolutionDesc: 'Erhalten Sie Hilfe beim schrittweisen L√∂sen von √úbungen',
                modePro: 'Pro-Modus',
                modeProDesc: 'Vertiefte Analysen, akademische Forschung und fortgeschrittene Projekte f√ºr Hochschulbildung',
                modeLanguages: 'Sprachenlernen',
                modeLanguagesDesc: 'Lernen Sie eine neue Sprache mit personalisierten √úbungen',
                aboutTitle: '√úber Lernen.IA',
                developedBy: 'Entwickelt von Jules',
                studentAt: 'Student in Bac Pro CIEL an St Fran√ßois d\'Assise',
                tagline: 'Lernen und √ºben Sie mit k√ºnstlicher Intelligenz'
            },
            spain: {
                chooseCountry: 'Elige tu pa√≠s',
                chooseClass: 'Elige tu curso',
                chooseSubject: 'Elige tu asignatura',
                back: 'Volver',
                change: 'Cambiar',
                send: 'Enviar',
                placeholder: 'Haz tu pregunta o pide un ejercicio...',
                modeRevision: 'Modo Revisi√≥n',
                modeRevisionDesc: 'Haz preguntas, pide explicaciones y profundiza tus conocimientos',
                modeQuiz: 'Modo Ejercicios',
                modeQuizDesc: 'Practica con ejercicios personalizados y recibe correcciones',
                modeResolution: 'Modo Resoluci√≥n',
                modeResolutionDesc: 'Obt√©n ayuda para resolver ejercicios paso a paso',
                modePro: 'Modo Pro',
                modeProDesc: 'An√°lisis profundos, investigaci√≥n acad√©mica y proyectos avanzados para estudios superiores',
                modeLanguages: 'Aprendizaje de Idiomas',
                modeLanguagesDesc: 'Aprende un nuevo idioma con ejercicios personalizados',
                aboutTitle: 'Acerca de Lernen.IA',
                developedBy: 'Desarrollado por Jules',
                studentAt: 'Estudiante de Bac Pro CIEL en St Fran√ßois d\'Assise',
                tagline: 'Estudia y practica con inteligencia artificial'
            }
        };

        const availableLanguages = [
            'Anglais', 'Espagnol', 'Allemand', 'Italien', 'Portugais', 'Chinois',
            'Japonais', 'Cor√©en', 'Arabe', 'Russe', 'N√©erlandais', 'Su√©dois',
            'Norv√©gien', 'Danois', 'Finnois', 'Polonais', 'Tch√®que', 'Hongrois',
            'Turc', 'Grec', 'H√©breu', 'Hindi', 'Tha√Ø', 'Vietnamien'
        ];

        const educationSystems = {
            france: {
                name: 'France',
                levels: {
                    cp: { name: 'CP', subjects: ['Math√©matiques', 'Fran√ßais', 'Sciences', 'Arts', 'EPS'] },
                    ce1: { name: 'CE1', subjects: ['Math√©matiques', 'Fran√ßais', 'Sciences', 'Histoire-G√©o', 'Arts', 'EPS'] },
                    ce2: { name: 'CE2', subjects: ['Math√©matiques', 'Fran√ßais', 'Sciences', 'Histoire-G√©o', 'Arts', 'Anglais'] },
                    cm1: { name: 'CM1', subjects: ['Math√©matiques', 'Fran√ßais', 'Sciences', 'Histoire-G√©o', 'Arts', 'Anglais'] },
                    cm2: { name: 'CM2', subjects: ['Math√©matiques', 'Fran√ßais', 'Sciences', 'Histoire-G√©o', 'Arts', 'Anglais'] },
                    '6eme': { name: '6√®me', subjects: ['Math√©matiques', 'Fran√ßais', 'SVT', 'Technologie', 'Histoire-G√©o', 'Anglais', 'Arts', 'EPS'] },
                    '5eme': { name: '5√®me', subjects: ['Math√©matiques', 'Fran√ßais', 'SVT', 'Physique-Chimie', 'Technologie', 'Histoire-G√©o', 'Anglais', 'Espagnol', 'Arts'] },
                    '4eme': { name: '4√®me', subjects: ['Math√©matiques', 'Fran√ßais', 'SVT', 'Physique-Chimie', 'Technologie', 'Histoire-G√©o', 'Anglais', 'Espagnol', 'Arts'] },
                    '3eme': { name: '3√®me', subjects: ['Math√©matiques', 'Fran√ßais', 'SVT', 'Physique-Chimie', 'Technologie', 'Histoire-G√©o', 'Anglais', 'Espagnol', 'Arts'] },
                    seconde: { name: 'Seconde', subjects: ['Math√©matiques', 'Fran√ßais', 'SVT', 'Physique-Chimie', 'Histoire-G√©o', 'SES', 'Anglais', 'Espagnol'] },
                    seconde_pro: { name: 'Seconde Pro', subjects: ['Math√©matiques Pro', 'Fran√ßais', 'Anglais', 'Histoire-G√©o', 'Enseignement Professionnel', 'Co-intervention', 'Chef d\'≈ìuvre'] },
                    premiere: { name: 'Premi√®re', subjects: ['Math√©matiques', 'Fran√ßais', 'Philosophie', 'Sp√©cialit√©s', 'Histoire-G√©o', 'Anglais', 'EPS'] },
                    premiere_pro: { name: 'Premi√®re Pro', subjects: ['Math√©matiques Pro', 'Fran√ßais', 'Anglais', 'Histoire-G√©o', 'Enseignement Professionnel', 'Co-intervention', 'Chef d\'≈ìuvre', 'PSE'] },
                    terminale: { name: 'Terminale', subjects: ['Math√©matiques', 'Philosophie', 'Sp√©cialit√©s', 'Histoire-G√©o', 'Anglais', 'Grand Oral'] },
                    terminale_pro: { name: 'Terminale Pro', subjects: ['Math√©matiques Pro', 'Fran√ßais', 'Anglais', 'Histoire-G√©o', 'Enseignement Professionnel', 'Chef d\'≈ìuvre', 'PSE', '√âconomie-Gestion'] },
                    cap1: { name: 'CAP 1√®re ann√©e', subjects: ['Math√©matiques-Sciences', 'Fran√ßais-Histoire-G√©o', 'Anglais', 'EPS', 'PSE', 'Enseignement Professionnel'] },
                    cap2: { name: 'CAP 2√®me ann√©e', subjects: ['Math√©matiques-Sciences', 'Fran√ßais-Histoire-G√©o', 'Anglais', 'EPS', 'PSE', 'Enseignement Professionnel', 'Chef d\'≈ìuvre'] },
                    bts: { name: 'BTS', subjects: ['Culture G√©n√©rale', 'Langue Vivante', 'Math√©matiques', 'Enseignements Professionnels', 'Gestion', 'Projet'] },
                    licence: { name: 'Licence', subjects: ['Sp√©cialisation', 'M√©thodologie', 'Langues', 'Projet', 'Stage'] },
                    licence_pro: { name: 'Licence Pro', subjects: ['Enseignements Professionnels', 'Projet Tutor√©', 'Stage', 'M√©moire Professionnel'] },
                    master: { name: 'Master', subjects: ['Recherche', 'Sp√©cialisation Avanc√©e', 'M√©moire', 'Stage', 'S√©minaires'] }
                }
            },
            usa: {
                name: 'United States',
                levels: {
                    kindergarten: { name: 'Kindergarten', subjects: ['Math', 'Reading', 'Science', 'Social Studies', 'Arts'] },
                    grade1: { name: 'Grade 1', subjects: ['Math', 'Reading', 'Writing', 'Science', 'Social Studies'] },
                    grade2: { name: 'Grade 2', subjects: ['Math', 'Reading', 'Writing', 'Science', 'Social Studies'] },
                    grade3: { name: 'Grade 3', subjects: ['Math', 'Reading', 'Writing', 'Science', 'Social Studies'] },
                    grade4: { name: 'Grade 4', subjects: ['Math', 'English', 'Science', 'Social Studies', 'Arts'] },
                    grade5: { name: 'Grade 5', subjects: ['Math', 'English', 'Science', 'Social Studies', 'Arts'] },
                    grade6: { name: 'Grade 6', subjects: ['Math', 'English', 'Science', 'Social Studies', 'PE'] },
                    grade7: { name: 'Grade 7', subjects: ['Math', 'English', 'Science', 'Social Studies', 'Foreign Language'] },
                    grade8: { name: 'Grade 8', subjects: ['Algebra', 'English', 'Science', 'History', 'Foreign Language'] },
                    grade9: { name: 'Grade 9 (Freshman)', subjects: ['Algebra/Geometry', 'English', 'Biology', 'World History', 'Foreign Language'] },
                    grade10: { name: 'Grade 10 (Sophomore)', subjects: ['Geometry/Algebra II', 'English', 'Chemistry', 'History', 'Foreign Language'] },
                    grade11: { name: 'Grade 11 (Junior)', subjects: ['Pre-Calculus', 'English', 'Physics', 'US History', 'Electives'] },
                    grade12: { name: 'Grade 12 (Senior)', subjects: ['Calculus', 'English', 'Science Elective', 'Government', 'AP Courses'] },
                    vocational: { name: 'Vocational School', subjects: ['Trade Skills', 'Math', 'English', 'Career Technical Education', 'Safety', 'Industry Certification'] },
                    community_college: { name: 'Community College', subjects: ['Associate Degree', 'Technical Programs', 'General Education', 'Career Preparation'] },
                    college: { name: 'College/University', subjects: ['Major Courses', 'General Education', 'Electives', 'Research', 'Capstone Project'] }
                }
            },
            uk: {
                name: 'United Kingdom',
                levels: {
                    year1: { name: 'Year 1', subjects: ['Maths', 'English', 'Science', 'History', 'Geography', 'Art'] },
                    year2: { name: 'Year 2', subjects: ['Maths', 'English', 'Science', 'History', 'Geography', 'Art'] },
                    year3: { name: 'Year 3', subjects: ['Maths', 'English', 'Science', 'History', 'Geography', 'Computing'] },
                    year4: { name: 'Year 4', subjects: ['Maths', 'English', 'Science', 'History', 'Geography', 'Languages'] },
                    year5: { name: 'Year 5', subjects: ['Maths', 'English', 'Science', 'History', 'Geography', 'Languages'] },
                    year6: { name: 'Year 6', subjects: ['Maths', 'English', 'Science', 'History', 'Geography', 'Languages'] },
                    year7: { name: 'Year 7', subjects: ['Maths', 'English', 'Science', 'History', 'Geography', 'Languages', 'Technology'] },
                    year8: { name: 'Year 8', subjects: ['Maths', 'English', 'Science', 'History', 'Geography', 'Languages', 'Technology'] },
                    year9: { name: 'Year 9', subjects: ['Maths', 'English', 'Science', 'Humanities', 'Languages', 'Options'] },
                    year10: { name: 'Year 10 (GCSE)', subjects: ['Maths', 'English', 'Sciences', 'Options'] },
                    year11: { name: 'Year 11 (GCSE)', subjects: ['Maths', 'English', 'Sciences', 'Options'] },
                    year12: { name: 'Year 12 (A-Level)', subjects: ['3-4 A-Level Subjects', 'Extended Project'] },
                    year13: { name: 'Year 13 (A-Level)', subjects: ['3-4 A-Level Subjects', 'University Prep'] },
                    btec: { name: 'BTEC', subjects: ['Vocational Units', 'Applied Learning', 'Work Experience', 'Portfolio', 'Industry Skills'] },
                    apprenticeship: { name: 'Apprenticeship', subjects: ['On-the-job Training', 'Technical Skills', 'Professional Development', 'Industry Standards'] },
                    university: { name: 'University', subjects: ['Degree Courses', 'Dissertation', 'Research', 'Seminars'] }
                }
            },
            germany: {
                name: 'Deutschland',
                levels: {
                    klasse1: { name: 'Klasse 1', subjects: ['Mathematik', 'Deutsch', 'Sachunterricht', 'Kunst', 'Sport'] },
                    klasse2: { name: 'Klasse 2', subjects: ['Mathematik', 'Deutsch', 'Sachunterricht', 'Kunst', 'Sport'] },
                    klasse3: { name: 'Klasse 3', subjects: ['Mathematik', 'Deutsch', 'Sachunterricht', 'Englisch', 'Kunst'] },
                    klasse4: { name: 'Klasse 4', subjects: ['Mathematik', 'Deutsch', 'Sachunterricht', 'Englisch', 'Kunst'] },
                    klasse5: { name: 'Klasse 5', subjects: ['Mathematik', 'Deutsch', 'Englisch', 'Biologie', 'Geschichte', 'Erdkunde'] },
                    klasse6: { name: 'Klasse 6', subjects: ['Mathematik', 'Deutsch', 'Englisch', 'Biologie', 'Geschichte', 'Physik'] },
                    klasse7: { name: 'Klasse 7', subjects: ['Mathematik', 'Deutsch', 'Englisch', 'Biologie', 'Chemie', 'Physik', 'Geschichte'] },
                    klasse8: { name: 'Klasse 8', subjects: ['Mathematik', 'Deutsch', 'Englisch', 'Biologie', 'Chemie', 'Physik', 'Geschichte'] },
                    klasse9: { name: 'Klasse 9', subjects: ['Mathematik', 'Deutsch', 'Englisch', 'Naturwissenschaften', 'Gesellschaftslehre'] },
                    klasse10: { name: 'Klasse 10', subjects: ['Mathematik', 'Deutsch', 'Englisch', 'Naturwissenschaften', 'Gesellschaftslehre'] },
                    klasse11: { name: 'Klasse 11 (Oberstufe)', subjects: ['Mathematik', 'Deutsch', 'Englisch', 'Leistungskurse', 'Grundkurse'] },
                    klasse12: { name: 'Klasse 12 (Abitur)', subjects: ['Mathematik', 'Deutsch', 'Leistungskurse', 'Grundkurse', 'Abiturpr√ºfung'] },
                    berufsschule: { name: 'Berufsschule', subjects: ['Fachtheorie', 'Fachpraxis', 'Allgemeinbildung', 'Betriebliche Ausbildung', 'Pr√ºfungsvorbereitung'] },
                    fachhochschule: { name: 'Fachhochschule', subjects: ['Angewandte Wissenschaften', 'Praxisprojekte', 'Praktikum', 'Abschlussarbeit'] },
                    universitat: { name: 'Universit√§t', subjects: ['Studienfach', 'Seminare', 'Forschung', 'Abschlussarbeit'] }
                }
            },
            spain: {
                name: 'Espa√±a',
                levels: {
                    primero: { name: '1¬∫ Primaria', subjects: ['Matem√°ticas', 'Lengua', 'Ciencias Naturales', 'Ciencias Sociales', 'Arte'] },
                    segundo: { name: '2¬∫ Primaria', subjects: ['Matem√°ticas', 'Lengua', 'Ciencias Naturales', 'Ciencias Sociales', 'Ingl√©s'] },
                    tercero: { name: '3¬∫ Primaria', subjects: ['Matem√°ticas', 'Lengua', 'Ciencias Naturales', 'Ciencias Sociales', 'Ingl√©s'] },
                    cuarto: { name: '4¬∫ Primaria', subjects: ['Matem√°ticas', 'Lengua', 'Ciencias Naturales', 'Ciencias Sociales', 'Ingl√©s'] },
                    quinto: { name: '5¬∫ Primaria', subjects: ['Matem√°ticas', 'Lengua', 'Ciencias Naturales', 'Ciencias Sociales', 'Ingl√©s'] },
                    sexto: { name: '6¬∫ Primaria', subjects: ['Matem√°ticas', 'Lengua', 'Ciencias Naturales', 'Ciencias Sociales', 'Ingl√©s'] },
                    '1eso': { name: '1¬∫ ESO', subjects: ['Matem√°ticas', 'Lengua', 'Ingl√©s', 'Biolog√≠a', 'Geograf√≠a', 'Tecnolog√≠a'] },
                    '2eso': { name: '2¬∫ ESO', subjects: ['Matem√°ticas', 'Lengua', 'Ingl√©s', 'F√≠sica y Qu√≠mica', 'Historia', 'Tecnolog√≠a'] },
                    '3eso': { name: '3¬∫ ESO', subjects: ['Matem√°ticas', 'Lengua', 'Ingl√©s', 'Biolog√≠a', 'F√≠sica y Qu√≠mica', 'Geograf√≠a'] },
                    '4eso': { name: '4¬∫ ESO', subjects: ['Matem√°ticas', 'Lengua', 'Ingl√©s', 'F√≠sica y Qu√≠mica', 'Historia', 'Optativas'] },
                    '1bach': { name: '1¬∫ Bachillerato', subjects: ['Matem√°ticas', 'Lengua', 'Ingl√©s', 'Filosof√≠a', 'Modalidad'] },
                    '2bach': { name: '2¬∫ Bachillerato', subjects: ['Matem√°ticas', 'Lengua', 'Historia', 'Modalidad', 'Selectividad'] },
                    fp_basica: { name: 'FP B√°sica', subjects: ['Comunicaci√≥n', 'Matem√°ticas Aplicadas', 'Ciencias Aplicadas', 'M√≥dulos Profesionales', 'FCT'] },
                    fp_medio: { name: 'FP Grado Medio', subjects: ['M√≥dulos Profesionales', 'FOL', 'Ingl√©s T√©cnico', 'FCT', 'Proyecto'] },
                    fp_superior: { name: 'FP Grado Superior', subjects: ['M√≥dulos Profesionales', 'Proyecto', 'FOL', 'Ingl√©s T√©cnico', 'FCT'] },
                    universidad: { name: 'Universidad', subjects: ['Carrera', 'Asignaturas', 'Trabajo Final', 'Pr√°cticas'] }
                }
            }
        };

        let state = {
            selectedCountry: '',
            selectedLevel: '',
            selectedSubject: '',
            mode: 'menu',
            messages: [],
            inputText: '',
            isLoading: false,
            showInfo: false,
            showProMode: false,
            showLanguagesMenu: false
        };

        function render() {
            const app = document.getElementById('app');
            
            if (state.mode === 'revision' || state.mode === 'quiz' || state.mode === 'resolution' || state.mode === 'pro' || state.mode === 'languages') {
                app.innerHTML = renderChatView();
                setTimeout(() => setupEventListeners(), 0);
            } else {
                app.innerHTML = renderMenuView();
                setTimeout(() => setupMenuListeners(), 0);
            }
        }

        function setupEventListeners() {
            const inputEl = document.getElementById('input-text');
            const btnSend = document.getElementById('btn-send');
            
            if (inputEl) {
                inputEl.addEventListener('input', (e) => {
                    state.inputText = e.target.value;
                    // Update button state
                    if (btnSend) {
                        if (state.inputText.trim() && !state.isLoading) {
                            btnSend.disabled = false;
                            btnSend.classList.remove('opacity-50', 'cursor-not-allowed');
                        } else {
                            btnSend.disabled = true;
                            btnSend.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    }
                });
                
                inputEl.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // Reset button in chat
            const btnReset = document.getElementById('btn-reset');
            if (btnReset) {
                btnReset.addEventListener('click', resetSession);
            }

            // Send button in chat
            if (btnSend) {
                btnSend.addEventListener('click', sendMessage);
            }
        }

        function renderChatView() {
            const t = translations[state.selectedCountry];
            let modeTitle = '';
            if (state.mode === 'revision') modeTitle = 'üß† ' + t.modeRevision;
            else if (state.mode === 'quiz') modeTitle = 'üìù ' + t.modeQuiz;
            else if (state.mode === 'resolution') modeTitle = '‚úÖ ' + t.modeResolution;
            else if (state.mode === 'pro') modeTitle = 'üéì ' + t.modePro;
            else if (state.mode === 'languages') modeTitle = 'üåç ' + t.modeLanguages;
            
            const messagesHTML = state.messages.map((msg, idx) => `
                <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-3xl rounded-2xl p-4 ${msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800'}">
                        <p class="whitespace-pre-wrap">${msg.content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" class="underline hover:opacity-80">$1</a>')}</p>
                    </div>
                </div>
            `).join('');

            const loadingHTML = state.isLoading ? `
                <div class="flex justify-start">
                    <div class="bg-gray-100 rounded-2xl p-4">
                        <div class="flex gap-2">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                </div>
            ` : '';

            return `
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h2 class="text-2xl font-bold flex items-center gap-2">
                                        ${modeTitle}
                                    </h2>
                                    <p class="text-indigo-100 mt-1">${state.selectedSubject} - ${educationSystems[state.selectedCountry].levels[state.selectedLevel].name}</p>
                                </div>
                                <button id="btn-reset" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-50 transition">
                                    ${t.change}
                                </button>
                            </div>
                        </div>

                        <div class="h-96 overflow-y-auto p-6 space-y-4" id="messages-container">
                            ${messagesHTML}
                            ${loadingHTML}
                        </div>

                        <div class="border-t p-4 bg-gray-50">
                            <div class="flex gap-2">
                                <textarea 
                                    id="input-text"
                                    placeholder="${t.placeholder}"
                                    class="flex-1 border rounded-xl p-3 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    rows="2"
                                >${state.inputText}</textarea>
                                <button 
                                    id="btn-send"
                                    disabled
                                    class="bg-indigo-600 text-white px-6 rounded-xl font-semibold hover:bg-indigo-700 transition opacity-50 cursor-not-allowed"
                                >
                                    ${t.send}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMenuView() {
            const t = translations[state.selectedCountry] || translations.france;
            
            let content = `
                <div class="max-w-6xl mx-auto">
                    <div class="text-center mb-8 pt-8">
                        <div class="flex justify-center mb-4">
                            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 rounded-2xl">
                                üéì
                            </div>
                        </div>
                        <h1 class="text-5xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">
                            Lernen.IA
                        </h1>
                        <p class="text-xl text-gray-600">${t.tagline}</p>
                        <button id="btn-info" class="mt-4 text-indigo-600 hover:text-indigo-800 flex items-center gap-2 mx-auto">
                            ‚ÑπÔ∏è ${t.aboutTitle}
                        </button>
                        ${state.showInfo ? `
                            <div class="mt-4 bg-white rounded-xl p-6 text-left max-w-2xl mx-auto shadow-lg">
                                <h3 class="font-bold text-lg mb-2">${t.developedBy}</h3>
                                <p class="text-gray-700 mb-3">${t.studentAt}</p>
                                <div class="space-y-2">
                                    <a href="https://www.instagram.com/jules_mat_/" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-indigo-600 hover:text-indigo-800">
                                        üì∏ Instagram: @jules_mat_
                                    </a>
                                    <a href="https://github.com/Jules446" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-indigo-600 hover:text-indigo-800">
                                        üíª GitHub: Jules446
                                    </a>
                                </div>
                            </div>
                        ` : ''}
                    </div>
            `;

            if (!state.selectedCountry) {
                content += `
                    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            üåç ${t.chooseCountry}
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            ${Object.entries(educationSystems).map(([key, system]) => `
                                <button data-country="${key}" class="btn-country p-6 rounded-xl font-semibold transition transform hover:scale-105 bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg hover:shadow-xl">
                                    ${system.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (!state.selectedLevel) {
                content += `
                    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                ‚ú® ${t.chooseClass} (${educationSystems[state.selectedCountry].name})
                            </h2>
                            <button id="btn-back-country" class="flex items-center gap-2 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-200 transition">
                                ‚Üê ${t.back}
                            </button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            ${Object.entries(educationSystems[state.selectedCountry].levels).map(([key, level]) => `
                                <button data-level="${key}" class="btn-level p-4 rounded-xl font-semibold transition transform hover:scale-105 bg-gray-100 text-gray-700 hover:bg-gray-200">
                                    ${level.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                content += `
                    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                üìö ${t.chooseSubject}
                            </h2>
                            <button id="btn-back-level" class="flex items-center gap-2 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-200 transition">
                                ‚Üê ${t.back}
                            </button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            ${educationSystems[state.selectedCountry].levels[state.selectedLevel].subjects.map(subject => `
                                <button data-subject="${subject}" class="btn-subject p-4 rounded-xl font-semibold transition transform hover:scale-105 ${state.selectedSubject === subject ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    ${subject}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;

                if (state.selectedSubject) {
                    const showLanguagesButton = state.selectedSubject !== 'LANGUES';
                    const numCols = state.showProMode && showLanguagesButton ? 'md:grid-cols-5' : 
                                    state.showProMode || showLanguagesButton ? 'md:grid-cols-4' : 'md:grid-cols-3';
                    
                    content += `
                        <div class="grid ${numCols} gap-6">
                            <button data-mode="revision" class="btn-mode bg-white rounded-2xl shadow-xl p-8 hover:shadow-2xl transition transform hover:scale-105">
                                <div class="flex flex-col items-center text-center">
                                    <div class="bg-blue-100 p-4 rounded-full mb-4">
                                        <span class="text-4xl">üß†</span>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-2">${t.modeRevision}</h3>
                                    <p class="text-gray-600">${t.modeRevisionDesc}</p>
                                </div>
                            </button>

                            <button data-mode="quiz" class="btn-mode bg-white rounded-2xl shadow-xl p-8 hover:shadow-2xl transition transform hover:scale-105">
                                <div class="flex flex-col items-center text-center">
                                    <div class="bg-purple-100 p-4 rounded-full mb-4">
                                        <span class="text-4xl">üìù</span>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-2">${t.modeQuiz}</h3>
                                    <p class="text-gray-600">${t.modeQuizDesc}</p>
                                </div>
                            </button>

                            <button data-mode="resolution" class="btn-mode bg-white rounded-2xl shadow-xl p-8 hover:shadow-2xl transition transform hover:scale-105">
                                <div class="flex flex-col items-center text-center">
                                    <div class="bg-green-100 p-4 rounded-full mb-4">
                                        <span class="text-4xl">‚úÖ</span>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-2">${t.modeResolution}</h3>
                                    <p class="text-gray-600">${t.modeResolutionDesc}</p>
                                </div>
                            </button>

                            ${state.showProMode ? `
                            <button data-mode="pro" class="btn-mode bg-white rounded-2xl shadow-xl p-8 hover:shadow-2xl transition transform hover:scale-105 border-2 border-indigo-600">
                                <div class="flex flex-col items-center text-center">
                                    <div class="bg-indigo-100 p-4 rounded-full mb-4">
                                        <span class="text-4xl">üéì</span>
                                    </div>
                                    <h3 class="text-2xl font-bold text-indigo-800 mb-2">${t.modePro}</h3>
                                    <p class="text-gray-600">${t.modeProDesc}</p>
                                </div>
                            </button>
                            ` : ''}
                            
                            ${showLanguagesButton ? `
                            <button id="btn-show-languages" class="bg-white rounded-2xl shadow-xl p-8 hover:shadow-2xl transition transform hover:scale-105 border-2 border-green-600">
                                <div class="flex flex-col items-center text-center">
                                    <div class="bg-green-100 p-4 rounded-full mb-4">
                                        <span class="text-4xl">üåç</span>
                                    </div>
                                    <h3 class="text-2xl font-bold text-green-800 mb-2">${t.modeLanguages}</h3>
                                    <p class="text-gray-600">${t.modeLanguagesDesc}</p>
                                </div>
                            </button>
                            ` : ''}
                        </div>
                    `;
                }
            }

            content += `</div>`;
            
            if (state.showLanguagesMenu) {
                content += `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" id="languages-overlay">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[80vh] overflow-y-auto p-8" id="languages-modal">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-3xl font-bold text-gray-800">üåç ${t.modeLanguages}</h2>
                                <button id="btn-close-languages" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
                            </div>
                            <p class="text-gray-600 mb-6">Choisissez une langue √† apprendre :</p>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                ${availableLanguages.map(lang => `
                                    <button data-language="${lang}" class="btn-language p-4 rounded-xl font-semibold transition transform hover:scale-105 bg-gradient-to-r from-green-600 to-emerald-600 text-white shadow-lg hover:shadow-xl">
                                        ${lang}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        function toggleInfo() {
            state.showInfo = !state.showInfo;
            render();
            setupMenuListeners();
        }

        function selectCountry(country) {
            state.selectedCountry = country;
            state.selectedLevel = '';
            state.selectedSubject = '';
            render();
            setupMenuListeners();
        }

        function selectLevel(level) {
            state.selectedLevel = level;
            state.selectedSubject = '';
            
            const higherEducationLevels = ['bts', 'licence', 'master', 'licence_pro', 'college', 'community_college', 'university', 'universitat', 'fachhochschule', 'universidad', 'btec', 'apprenticeship', 'berufsschule', 'vocational', 'fp_superior', 'fp_medio', 'fp_basica', 'seconde_pro', 'premiere_pro', 'terminale_pro', 'cap1', 'cap2'];
            state.showProMode = higherEducationLevels.includes(level);
            
            render();
            setupMenuListeners();
        }

        function selectSubject(subject) {
            state.selectedSubject = subject;
            render();
            setupMenuListeners();
        }

        function startSession(mode) {
            state.mode = mode;
            const t = translations[state.selectedCountry];
            const levelName = educationSystems[state.selectedCountry].levels[state.selectedLevel].name;
            const subject = state.selectedSubject;
            let welcomeMessage = '';
            
            if (mode === 'revision') {
                if (state.selectedCountry === 'france') {
                    welcomeMessage = `Bonjour ! Je suis Lernen.IA, votre assistant pour r√©viser ${subject} niveau ${levelName}. Posez-moi vos questions ou demandez-moi d'expliquer un concept !`;
                } else if (state.selectedCountry === 'usa' || state.selectedCountry === 'uk') {
                    welcomeMessage = `Hello! I'm Lernen.IA, your assistant for reviewing ${subject} at ${levelName} level. Ask me your questions or request explanations!`;
                } else if (state.selectedCountry === 'germany') {
                    welcomeMessage = `Hallo! Ich bin Lernen.IA, Ihr Assistent f√ºr ${subject} in ${levelName}. Stellen Sie mir Ihre Fragen oder bitten Sie um Erkl√§rungen!`;
                } else if (state.selectedCountry === 'spain') {
                    welcomeMessage = `¬°Hola! Soy Lernen.IA, tu asistente para repasar ${subject} en ${levelName}. ¬°Hazme tus preguntas o pide explicaciones!`;
                }
            } else if (mode === 'quiz') {
                if (state.selectedCountry === 'france') {
                    welcomeMessage = `Pr√™t pour des exercices de ${subject} niveau ${levelName} ? Je suis Lernen.IA et je vais vous cr√©er des exercices adapt√©s. Dites-moi quel chapitre ou concept vous voulez pratiquer !`;
                } else if (state.selectedCountry === 'usa' || state.selectedCountry === 'uk') {
                    welcomeMessage = `Ready for ${subject} exercises at ${levelName} level? I'm Lernen.IA and I'll create adapted exercises for you. Tell me which chapter or concept you want to practice!`;
                } else if (state.selectedCountry === 'germany') {
                    welcomeMessage = `Bereit f√ºr ${subject}-√úbungen in ${levelName}? Ich bin Lernen.IA und erstelle angepasste √úbungen f√ºr Sie. Sagen Sie mir, welches Kapitel oder Konzept Sie √ºben m√∂chten!`;
                } else if (state.selectedCountry === 'spain') {
                    welcomeMessage = `¬øListo para ejercicios de ${subject} en ${levelName}? Soy Lernen.IA y crear√© ejercicios adaptados para ti. ¬°Dime qu√© cap√≠tulo o concepto quieres practicar!`;
                }
            } else if (mode === 'resolution') {
                if (state.selectedCountry === 'france') {
                    welcomeMessage = `Besoin d'aide pour r√©soudre un exercice de ${subject} niveau ${levelName} ? Je suis Lernen.IA et je vais vous aider √©tape par √©tape. Envoyez-moi votre exercice ou d√©crivez-le !`;
                } else if (state.selectedCountry === 'usa' || state.selectedCountry === 'uk') {
                    welcomeMessage = `Need help solving a ${subject} exercise at ${levelName} level? I'm Lernen.IA and I'll help you step by step. Send me your exercise or describe it!`;
                } else if (state.selectedCountry === 'germany') {
                    welcomeMessage = `Ben√∂tigen Sie Hilfe beim L√∂sen einer ${subject}-√úbung in ${levelName}? Ich bin Lernen.IA und helfe Ihnen Schritt f√ºr Schritt. Senden Sie mir Ihre √úbung oder beschreiben Sie sie!`;
                } else if (state.selectedCountry === 'spain') {
                    welcomeMessage = `¬øNecesitas ayuda para resolver un ejercicio de ${subject} en ${levelName}? Soy Lernen.IA y te ayudar√© paso a paso. ¬°Env√≠ame tu ejercicio o descr√≠belo!`;
                }
            } else if (mode === 'pro') {
                if (state.selectedCountry === 'france') {
                    welcomeMessage = `Bienvenue dans le Mode Pro pour ${subject} niveau ${levelName}. Je suis Lernen.IA et je peux vous aider avec : analyses approfondies, recherche acad√©mique, r√©daction de m√©moires, m√©thodologie de recherche, analyses critiques, projets avanc√©s. Quel est votre projet ou besoin ?`;
                } else if (state.selectedCountry === 'usa' || state.selectedCountry === 'uk') {
                    welcomeMessage = `Welcome to Pro Mode for ${subject} at ${levelName} level. I'm Lernen.IA and I can help you with: in-depth analysis, academic research, thesis writing, research methodology, critical analysis, advanced projects. What is your project or need?`;
                } else if (state.selectedCountry === 'germany') {
                    welcomeMessage = `Willkommen im Pro-Modus f√ºr ${subject} in ${levelName}. Ich bin Lernen.IA und kann Ihnen helfen mit: vertiefter Analyse, akademischer Forschung, Abschlussarbeit, Forschungsmethodik, kritischer Analyse, fortgeschrittenen Projekten. Was ist Ihr Projekt oder Bedarf?`;
                } else if (state.selectedCountry === 'spain') {
                    welcomeMessage = `Bienvenido al Modo Pro para ${subject} en ${levelName}. Soy Lernen.IA y puedo ayudarte con: an√°lisis profundos, investigaci√≥n acad√©mica, redacci√≥n de tesis, metodolog√≠a de investigaci√≥n, an√°lisis cr√≠ticos, proyectos avanzados. ¬øCu√°l es tu proyecto o necesidad?`;
                }
            } else if (mode === 'languages') {
                if (state.selectedCountry === 'france') {
                    welcomeMessage = `Bienvenue dans le mode apprentissage des langues ! Je suis Lernen.IA et je vais vous aider √† apprendre ${state.selectedSubject.replace('LANGUES - ', '')}. Quel est votre niveau actuel et que souhaitez-vous travailler ?`;
                } else {
                    welcomeMessage = `Welcome to language learning mode! I'm Lernen.IA and I'll help you learn ${state.selectedSubject.replace('LANGUES - ', '')}. What's your current level and what would you like to work on?`;
                }
            }
            
            state.messages = [{ role: 'assistant', content: welcomeMessage }];
            render();
            scrollToBottom();
        }

        function resetSession() {
            state.mode = 'menu';
            state.messages = [];
            state.selectedSubject = '';
            state.selectedLevel = '';
            state.selectedCountry = '';
            render();
            setupMenuListeners();
        }

        async function sendMessage() {
            const inputEl = document.getElementById('input-text');
            if (!inputEl) return;
            
            const userMessage = inputEl.value.trim();
            
            if (!userMessage || state.isLoading) return;

            state.inputText = '';
            state.messages.push({ role: 'user', content: userMessage });
            state.isLoading = true;
            render();
            scrollToBottom();

            try {
                const systemLanguage = state.selectedCountry === 'france' ? 'fran√ßais' : 
                                     state.selectedCountry === 'usa' || state.selectedCountry === 'uk' ? 'English' :
                                     state.selectedCountry === 'germany' ? 'Deutsch' : 'espa√±ol';
                
                let systemPrompt = '';
                
                if (state.mode === 'revision') {
                    systemPrompt = `Tu es Lernen.IA, un assistant √©ducatif. R√©ponds TOUJOURS en ${systemLanguage}. Tu enseignes ${state.selectedSubject} pour le niveau ${educationSystems[state.selectedCountry].levels[state.selectedLevel].name} dans le syst√®me √©ducatif ${educationSystems[state.selectedCountry].name}. Explique les concepts de mani√®re claire et p√©dagogique. Utilise des exemples concrets. Si l'√©tudiant pose une question, r√©ponds de fa√ßon d√©taill√©e mais accessible. Si on te demande qui tu es, r√©ponds: "Je suis Lernen.IA, d√©velopp√© par Jules, un √©tudiant de St Fran√ßois d'Assise en Bac Pro CIEL. Pour plus d'informations, visitez mon Instagram: https://www.instagram.com/jules_mat_/ ou mon GitHub: https://github.com/Jules446"`;
                } else if (state.mode === 'quiz') {
                    systemPrompt = `Tu es Lernen.IA, un assistant √©ducatif. R√©ponds TOUJOURS en ${systemLanguage}. Tu cr√©es des exercices de ${state.selectedSubject} pour le niveau ${educationSystems[state.selectedCountry].levels[state.selectedLevel].name} dans le syst√®me √©ducatif ${educationSystems[state.selectedCountry].name}. Cr√©e des exercices adapt√©s au niveau demand√© avec des questions progressives. Propose des exercices vari√©s (calculs, probl√®mes, questions de r√©flexion). Apr√®s que l'√©tudiant r√©ponde, corrige et explique les erreurs de mani√®re constructive. Si on te demande qui tu es, r√©ponds: "Je suis Lernen.IA, d√©velopp√© par Jules, un √©tudiant de St Fran√ßois d'Assise en Bac Pro CIEL. Pour plus d'informations, visitez mon Instagram: https://www.instagram.com/jules_mat_/ ou mon GitHub: https://github.com/Jules446"`;
                } else if (state.mode === 'resolution') {
                    systemPrompt = `Tu es Lernen.IA, un assistant √©ducatif. R√©ponds TOUJOURS en ${systemLanguage}. Tu aides √† r√©soudre des exercices de ${state.selectedSubject} pour le niveau ${educationSystems[state.selectedCountry].levels[state.selectedLevel].name} dans le syst√®me √©ducatif ${educationSystems[state.selectedCountry].name}. L'√©tudiant t'envoie un exercice qu'il doit r√©soudre. Guide-le √©tape par √©tape dans la r√©solution. Ne donne JAMAIS directement la solution compl√®te. Pose des questions pour le faire r√©fl√©chir. Propose des indices progressifs. Aide-le √† comprendre chaque √©tape du raisonnement. F√©licite ses bonnes r√©ponses et aide-le √† corriger ses erreurs. Si on te demande qui tu es, r√©ponds: "Je suis Lernen.IA, d√©velopp√© par Jules, un √©tudiant de St Fran√ßois d'Assise en Bac Pro CIEL. Pour plus d'informations, visitez mon Instagram: https://www.instagram.com/jules_mat_/ ou mon GitHub: https://github.com/Jules446"`;
                } else if (state.mode === 'pro') {
                    systemPrompt = `Tu es Lernen.IA Pro, un assistant √©ducatif avanc√© pour √©tudes sup√©rieures. R√©ponds TOUJOURS en ${systemLanguage}. Tu assistes des √©tudiants en ${state.selectedSubject} de niveau ${educationSystems[state.selectedCountry].levels[state.selectedLevel].name}. Tu peux : analyser en profondeur des concepts complexes, aider √† la recherche acad√©mique, guider la r√©daction de m√©moires et th√®ses, enseigner la m√©thodologie de recherche, effectuer des analyses critiques de sources, aider sur des projets avanc√©s et sp√©cialis√©s. Adopte un ton professionnel mais accessible. Fournis des r√©ponses d√©taill√©es avec r√©f√©rences th√©oriques quand appropri√©. Encourage la pens√©e critique et l'autonomie intellectuelle. Si on te demande qui tu es, r√©ponds: "Je suis Lernen.IA, d√©velopp√© par Jules, un √©tudiant de St Fran√ßois d'Assise en Bac Pro CIEL. Pour plus d'informations, visitez mon Instagram: https://www.instagram.com/jules_mat_/ ou mon GitHub: https://github.com/Jules446"`;
                } else if (state.mode === 'languages') {
                    const targetLang = state.selectedSubject.replace('LANGUES - ', '');
                    systemPrompt = `Tu es Lernen.IA, un assistant pour l'apprentissage des langues. R√©ponds TOUJOURS en ${systemLanguage}. Tu aides l'√©tudiant √† apprendre ${targetLang}. Propose des exercices, des explications grammaticales, du vocabulaire, et des conseils de prononciation. Adapte ton enseignement au niveau de l'√©tudiant. Sois patient et encourageant. Si on te demande qui tu es, r√©ponds: "Je suis Lernen.IA, d√©velopp√© par Jules, un √©tudiant de St Fran√ßois d'Assise en Bac Pro CIEL. Pour plus d'informations, visitez mon Instagram: https://www.instagram.com/jules_mat_/ ou mon GitHub: https://github.com/Jules446"`;
                }

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        system: systemPrompt,
                        messages: state.messages.map(msg => ({
                            role: msg.role,
                            content: msg.content
                        }))
                    })
                });

                const data = await response.json();
                const assistantMessage = data.content
                    .filter(block => block.type === 'text')
                    .map(block => block.text)
                    .join('\n');

                state.messages.push({ role: 'assistant', content: assistantMessage });
            } catch (error) {
                state.messages.push({ 
                    role: 'assistant', 
                    content: "D√©sol√©, une erreur s'est produite. Veuillez r√©essayer." 
                });
            } finally {
                state.isLoading = false;
                render();
                scrollToBottom();
            }
        }

        function scrollToBottom() {
            setTimeout(() => {
                const container = document.getElementById('messages-container');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }, 100);
        }

        function showLanguagesMenu() {
            state.showLanguagesMenu = true;
            render();
            setupMenuListeners();
        }

        function hideLanguagesMenu() {
            state.showLanguagesMenu = false;
            render();
            setupMenuListeners();
        }

        function startLanguageSession(language) {
            state.selectedSubject = 'LANGUES - ' + language;
            state.showLanguagesMenu = false;
            startSession('languages');
        }

        function setupMenuListeners() {
            // Info button
            const btnInfo = document.getElementById('btn-info');
            if (btnInfo) {
                btnInfo.addEventListener('click', toggleInfo);
            }

            // Country buttons
            document.querySelectorAll('.btn-country').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectCountry(btn.dataset.country);
                });
            });

            // Back to country button
            const btnBackCountry = document.getElementById('btn-back-country');
            if (btnBackCountry) {
                btnBackCountry.addEventListener('click', () => {
                    selectCountry('');
                });
            }

            // Level buttons
            document.querySelectorAll('.btn-level').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectLevel(btn.dataset.level);
                });
            });

            // Back to level button
            const btnBackLevel = document.getElementById('btn-back-level');
            if (btnBackLevel) {
                btnBackLevel.addEventListener('click', () => {
                    selectLevel('');
                });
            }

            // Subject buttons
            document.querySelectorAll('.btn-subject').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectSubject(btn.dataset.subject);
                });
            });

            // Mode buttons
            document.querySelectorAll('.btn-mode').forEach(btn => {
                btn.addEventListener('click', () => {
                    startSession(btn.dataset.mode);
                });
            });

            // Show languages button
            const btnShowLanguages = document.getElementById('btn-show-languages');
            if (btnShowLanguages) {
                btnShowLanguages.addEventListener('click', showLanguagesMenu);
            }

            // Close languages modal
            const btnCloseLanguages = document.getElementById('btn-close-languages');
            if (btnCloseLanguages) {
                btnCloseLanguages.addEventListener('click', hideLanguagesMenu);
            }

            // Languages overlay
            const languagesOverlay = document.getElementById('languages-overlay');
            if (languagesOverlay) {
                languagesOverlay.addEventListener('click', hideLanguagesMenu);
            }

            // Languages modal (prevent close when clicking inside)
            const languagesModal = document.getElementById('languages-modal');
            if (languagesModal) {
                languagesModal.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            // Language buttons
            document.querySelectorAll('.btn-language').forEach(btn => {
                btn.addEventListener('click', () => {
                    startLanguageSession(btn.dataset.language);
                });
            });

            // Reset button in chat
            const btnReset = document.getElementById('btn-reset');
            if (btnReset) {
                btnReset.addEventListener('click', resetSession);
            }

            // Send button in chat
            const btnSend = document.getElementById('btn-send');
            if (btnSend) {
                btnSend.addEventListener('click', sendMessage);
            }
        }

        // Initial render
        render();
        setupMenuListeners();
    </script>
</body>
</html>
